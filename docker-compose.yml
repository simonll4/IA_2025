services:
  pipeline-api:
    build:
      context: ./services/ocr-pipeline-python
      dockerfile: Dockerfile
    container_name: pipeline-api
    restart: unless-stopped
    ports:
      - "${API_HOST_PORT:-7001}:8000"
    env_file:
      - ./configs/env/.env
    environment:
      # Database
      DB_URL: ${DB_URL:-sqlite:///data/app.db}
      DB_PATH: ${DB_PATH:-/app/data/app.db}

    volumes:
      - ./data:/app/data
      - ./datasets:/app/datasets:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  invoice-agent-api:
    build:
      context: ./services/invoice-agent-python
      dockerfile: Dockerfile
    container_name: invoice-agent-api
    restart: unless-stopped
    env_file:
      - ./configs/env/.env
    environment:
      INVOICE_AGENT_API_PORT: 8100
      INVOICE_AGENT_MCP_ENDPOINT: ${INVOICE_AGENT_MCP_ENDPOINT:-http://mcp-sqlite:3000}

  mcp-sqlite:
    build:
      context: ./services/mcp-invoices-ts
      dockerfile: Dockerfile
    container_name: mcp-sqlite
    restart: unless-stopped
    env_file:
      - ./configs/env/.env
    environment:
      APP_DB_PATH: /app/data/app.db
      MCP_HTTP_PORT: 3000
    volumes:
      - ./data:/app/data:ro

  web-ui:
    build:
      context: ./services/web-ui
      dockerfile: Dockerfile
    container_name: web-ui
    restart: unless-stopped
    depends_on:
      - pipeline-api
      - invoice-agent-api
    ports:
      - "${HOST_PORT:-7000}:80"
